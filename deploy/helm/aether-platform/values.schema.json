{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://aether.example.com/helm/aether-platform/values.schema.json",
    "title": "Aether Platform Helm Values",
    "type": "object",
    "additionalProperties": true,
    "required": [
        "global",
        "backendServices",
        "ui"
    ],
    "$defs": {
        "image": {
            "type": "object",
            "description": "Container image settings must pin a repository and tag to avoid implicit upgrades.",
            "required": [
                "repository",
                "tag"
            ],
            "properties": {
                "repository": {
                    "type": "string",
                    "minLength": 1
                },
                "tag": {
                    "type": "string",
                    "minLength": 1
                }
            },
            "additionalProperties": true
        },
        "resourceQuantities": {
            "type": "object",
            "required": [
                "cpu",
                "memory"
            ],
            "properties": {
                "cpu": {
                    "type": "string",
                    "minLength": 1
                },
                "memory": {
                    "type": "string",
                    "minLength": 1
                }
            },
            "additionalProperties": true
        },
        "resources": {
            "type": "object",
            "description": "CPU and memory requests/limits are required for every workload to guarantee scheduling and enforce quotas.",
            "required": [
                "requests",
                "limits"
            ],
            "properties": {
                "requests": {
                    "$ref": "#/$defs/resourceQuantities"
                },
                "limits": {
                    "$ref": "#/$defs/resourceQuantities"
                }
            },
            "additionalProperties": false
        },
        "backendService": {
            "type": "object",
            "required": [
                "enabled",
                "image",
                "resources"
            ],
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "description": "Backend deployment toggles must be explicit so production rollouts cannot omit the gate.",
                    "default": true
                },
                "image": {
                    "$ref": "#/$defs/image"
                },
                "serviceAccountName": {
                    "type": "string",
                    "description": "Optional service account bound to the generated Deployment."
                },
                "envFrom": {
                    "type": "array",
                    "description": "Environment sources projected with envFrom, useful for opaque configuration secrets.",
                    "items": {
                        "type": "object",
                        "additionalProperties": true
                    }
                },
                "resources": {
                    "$ref": "#/$defs/resources"
                }
            },
            "additionalProperties": true
        },
        "postgresConnection": {
            "type": "object",
            "description": "Connection attributes for managed PostgreSQL secrets.",
            "required": [
                "database",
                "username",
                "password"
            ],
            "properties": {
                "host": {
                    "type": "string",
                    "description": "Override the hostname when using an external PostgreSQL instance."
                },
                "port": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Override the port when using a non-standard PostgreSQL listener."
                },
                "database": {
                    "type": "string",
                    "minLength": 1
                },
                "username": {
                    "type": "string",
                    "minLength": 1
                },
                "password": {
                    "type": "string",
                    "minLength": 1
                },
                "sslmode": {
                    "type": "string",
                    "minLength": 1
                },
                "parameters": {
                    "type": "object",
                    "description": "Additional query parameters appended to the generated DSN.",
                    "additionalProperties": {
                        "type": "string"
                    }
                }
            },
            "additionalProperties": true
        },
        "managedSecret": {
            "type": "object",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "default": true
                },
                "type": {
                    "type": "string",
                    "enum": [
                        "postgresDsn",
                        "opaque"
                    ],
                    "default": "opaque"
                },
                "dsnKey": {
                    "type": "string",
                    "description": "Key used to store the generated DSN when type is postgresDsn.",
                    "default": "dsn"
                },
                "sslmodeKey": {
                    "type": "string",
                    "description": "Key used to store the SSL mode alongside generated DSNs.",
                    "default": "sslmode"
                },
                "connection": {
                    "$ref": "#/$defs/postgresConnection"
                },
                "data": {
                    "type": "object",
                    "description": "Literal key/value pairs for opaque secrets.",
                    "additionalProperties": {
                        "type": "string"
                    }
                },
                "additionalData": {
                    "type": "object",
                    "description": "Additional key/value pairs appended to generated DSN secrets.",
                    "additionalProperties": {
                        "type": "string"
                    }
                }
            },
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "postgresDsn"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "connection"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "opaque"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "data"
                        ]
                    }
                }
            ],
            "additionalProperties": true
        },
        "serviceAccountSet": {
            "type": "object",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "default": true
                },
                "names": {
                    "type": "array",
                    "items": {
                        "type": "string",
                        "minLength": 1
                    }
                }
            },
            "additionalProperties": false
        },
        "pipelineService": {
            "type": "object",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "default": false
                },
                "type": {
                    "type": "string"
                },
                "ports": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "required": [
                            "port",
                            "targetPort"
                        ],
                        "properties": {
                            "name": {
                                "type": "string"
                            },
                            "port": {
                                "type": "integer",
                                "minimum": 1
                            },
                            "targetPort": {
                                "type": [
                                    "integer",
                                    "string"
                                ]
                            }
                        },
                        "additionalProperties": true
                    }
                }
            },
            "additionalProperties": true
        },
        "pipelineDeployment": {
            "type": "object",
            "required": [
                "image",
                "resources"
            ],
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "default": true
                },
                "image": {
                    "$ref": "#/$defs/image"
                },
                "resources": {
                    "$ref": "#/$defs/resources"
                },
                "service": {
                    "$ref": "#/$defs/pipelineService"
                }
            },
            "additionalProperties": true
        },
        "feastConfig": {
            "type": "object",
            "required": [
                "enabled",
                "image",
                "resources",
                "backup"
            ],
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "default": false
                },
                "image": {
                    "$ref": "#/$defs/image"
                },
                "resources": {
                    "$ref": "#/$defs/resources"
                },
                "backup": {
                    "type": "object",
                    "required": [
                        "image",
                        "objectStoreSecret"
                    ],
                    "properties": {
                        "image": {
                            "$ref": "#/$defs/image"
                        },
                        "objectStoreSecret": {
                            "type": "string",
                            "minLength": 1
                        }
                    },
                    "additionalProperties": true
                }
            },
            "additionalProperties": true
        },
        "postgresConnection": {
            "type": "object",
            "description": "Connection attributes for managed PostgreSQL secrets.",
            "required": [
                "database",
                "username",
                "password"
            ],
            "properties": {
                "host": {
                    "type": "string",
                    "description": "Override the hostname when using an external PostgreSQL instance."
                },
                "port": {
                    "type": "integer",
                    "minimum": 1,
                    "description": "Override the port when using a non-standard PostgreSQL listener."
                },
                "database": {
                    "type": "string",
                    "minLength": 1
                },
                "username": {
                    "type": "string",
                    "minLength": 1
                },
                "password": {
                    "type": "string",
                    "minLength": 1
                },
                "sslmode": {
                    "type": "string",
                    "minLength": 1
                },
                "parameters": {
                    "type": "object",
                    "description": "Additional query parameters appended to the generated DSN.",
                    "additionalProperties": {
                        "type": "string"
                    }
                }
            },
            "additionalProperties": true
        },
        "managedSecret": {
            "type": "object",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "default": true
                },
                "type": {
                    "type": "string",
                    "enum": [
                        "postgresDsn",
                        "opaque"
                    ],
                    "default": "opaque"
                },
                "dsnKey": {
                    "type": "string",
                    "description": "Key used to store the generated DSN when type is postgresDsn.",
                    "default": "dsn"
                },
                "sslmodeKey": {
                    "type": "string",
                    "description": "Key used to store the SSL mode alongside generated DSNs.",
                    "default": "sslmode"
                },
                "connection": {
                    "$ref": "#/$defs/postgresConnection"
                },
                "data": {
                    "type": "object",
                    "description": "Literal key/value pairs for opaque secrets.",
                    "additionalProperties": {
                        "type": "string"
                    }
                },
                "additionalData": {
                    "type": "object",
                    "description": "Additional key/value pairs appended to generated DSN secrets.",
                    "additionalProperties": {
                        "type": "string"
                    }
                }
            },
            "allOf": [
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "postgresDsn"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "connection"
                        ]
                    }
                },
                {
                    "if": {
                        "properties": {
                            "type": {
                                "const": "opaque"
                            }
                        }
                    },
                    "then": {
                        "required": [
                            "data"
                        ]
                    }
                }
            ],
            "additionalProperties": true
        }
    },
    "properties": {
        "global": {
            "type": "object",
            "description": "Global defaults applied to every workload in the chart.",
            "required": [
                "imagePullPolicy",
                "containerSecurityContext",
                "podSecurityContext"
            ],
            "properties": {
                "imagePullPolicy": {
                    "type": "string",
                    "enum": [
                        "Always",
                        "IfNotPresent",
                        "Never"
                    ]
                },
                "containerSecurityContext": {
                    "type": "object",
                    "description": "Container-level security controls must keep privilege escalation disabled and enforce a read-only root filesystem.",
                    "required": [
                        "allowPrivilegeEscalation",
                        "capabilities",
                        "readOnlyRootFilesystem"
                    ],
                    "properties": {
                        "allowPrivilegeEscalation": {
                            "type": "boolean",
                            "const": false
                        },
                        "readOnlyRootFilesystem": {
                            "type": "boolean",
                            "const": true
                        },
                        "capabilities": {
                            "type": "object",
                            "required": [
                                "drop"
                            ],
                            "properties": {
                                "drop": {
                                    "type": "array",
                                    "items": {
                                        "type": "string"
                                    },
                                    "contains": {
                                        "const": "ALL"
                                    },
                                    "minItems": 1
                                }
                            },
                            "additionalProperties": true
                        }
                    },
                    "additionalProperties": true
                },
                "podSecurityContext": {
                    "type": "object",
                    "description": "Pod-level security context must enforce non-root execution and default seccomp profile.",
                    "required": [
                        "runAsNonRoot",
                        "runAsUser",
                        "runAsGroup",
                        "fsGroup"
                    ],
                    "properties": {
                        "runAsNonRoot": {
                            "type": "boolean",
                            "const": true
                        },
                        "runAsUser": {
                            "type": "integer",
                            "minimum": 1
                        },
                        "runAsGroup": {
                            "type": "integer",
                            "minimum": 1
                        },
                        "fsGroup": {
                            "type": "integer",
                            "minimum": 1
                        }
                    },
                    "additionalProperties": true
                },
                "sessionStore": {
                    "type": "object",
                    "description": "Override the session Redis URL when not using the bundled dependency.",
                    "properties": {
                        "redisUrl": {
                            "type": "string"
                        }
                    },
                    "additionalProperties": false
                },
                "releaseManifest": {
                    "type": "object",
                    "description": "Configuration for the optional release manifest integration.",
                    "properties": {
                        "enabled": {
                            "type": "boolean",
                            "default": true
                        },
                        "databaseSecretName": {
                            "type": "string"
                        },
                        "databaseSecretKey": {
                            "type": "string"
                        },
                        "sslmode": {
                            "type": "string"
                        },
                        "appName": {
                            "type": "string"
                        }
                    },
                    "additionalProperties": true
                }
            },
            "additionalProperties": true
        },
        "simulation": {
            "type": "object",
            "description": "Controls access to the simulation workloads. These must remain disabled in production clusters.",
            "default": {
                "enabled": false
            },
            "required": [
                "enabled"
            ],
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "const": false,
                    "default": false,
                    "description": "Simulation traffic is disabled by default to prevent accidental activation in production."
                }
            },
            "additionalProperties": true
        },
        "runtimeSafety": {
            "type": "object",
            "description": "Global runtime safety flags that harden the chart against insecure defaults.",
            "default": {
                "_ALLOW_INSECURE_DEFAULTS": false
            },
            "required": [
                "_ALLOW_INSECURE_DEFAULTS"
            ],
            "properties": {
                "_ALLOW_INSECURE_DEFAULTS": {
                    "description": "Ensures insecure default fallbacks remain disabled across all workloads.",
                    "anyOf": [
                        {
                            "type": "boolean",
                            "const": false
                        },
                        {
                            "type": "string",
                            "enum": [
                                "0",
                                "false",
                                "False"
                            ]
                        }
                    ]
                }
            },
            "additionalProperties": true
        },
        "dependencies": {
            "type": "object",
            "description": "Configuration for bundled stateful dependencies that can be deployed alongside the platform.",
            "properties": {
                "postgresql": {
                    "type": "object",
                    "properties": {
                        "enabled": {
                            "type": "boolean",
                            "default": true
                        },
                        "fullnameOverride": {
                            "type": "string"
                        },
                        "auth": {
                            "type": "object",
                            "description": "Superuser credentials used by the bundled PostgreSQL release.",
                            "required": [
                                "username",
                                "password",
                                "database"
                            ],
                            "properties": {
                                "username": {
                                    "type": "string",
                                    "minLength": 1
                                },
                                "password": {
                                    "type": "string",
                                    "minLength": 1
                                },
                                "database": {
                                    "type": "string",
                                    "minLength": 1
                                }
                            },
                            "additionalProperties": true
                        },
                        "primary": {
                            "type": "object",
                            "description": "Primary instance configuration overrides passed to the Bitnami PostgreSQL chart.",
                            "properties": {
                                "initdbScriptsConfigMap": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": true
                        }
                    },
                    "additionalProperties": true
                },
                "redis": {
                    "type": "object",
                    "properties": {
                        "enabled": {
                            "type": "boolean",
                            "default": true
                        },
                        "fullnameOverride": {
                            "type": "string"
                        },
                        "architecture": {
                            "type": "string",
                            "enum": [
                                "standalone",
                                "replication"
                            ]
                        },
                        "auth": {
                            "type": "object",
                            "properties": {
                                "enabled": {
                                    "type": "boolean"
                                },
                                "password": {
                                    "type": "string"
                                }
                            },
                            "additionalProperties": true
                        }
                    },
                    "additionalProperties": true
                },
                "kafka": {
                    "type": "object",
                    "properties": {
                        "enabled": {
                            "type": "boolean",
                            "default": true
                        },
                        "fullnameOverride": {
                            "type": "string"
                        }
                    },
                    "additionalProperties": true
                },
                "nats": {
                    "type": "object",
                    "properties": {
                        "enabled": {
                            "type": "boolean",
                            "default": true
                        },
                        "fullnameOverride": {
                            "type": "string"
                        }
                    },
                    "additionalProperties": true
                }
            },
            "additionalProperties": true
        },
        "managedSecrets": {
            "type": "object",
            "description": "Declarative secrets generated by the chart for quick-start deployments.",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "default": true
                },
                "secrets": {
                    "type": "object",
                    "additionalProperties": {
                        "$ref": "#/$defs/managedSecret"
                    }
                }
            },
            "additionalProperties": false
        },
        "serviceAccounts": {
            "$ref": "#/$defs/serviceAccountSet"
        },
        "backendServices": {
            "type": "object",
            "description": "Collection of backend workloads deployed as part of the platform.",
            "minProperties": 1,
            "patternProperties": {
                "^[A-Za-z0-9_-]+$": {
                    "$ref": "#/$defs/backendService"
                }
            },
            "additionalProperties": false
        },
        "dataPipelines": {
            "type": "object",
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "default": true
                },
                "sharedConfig": {
                    "type": "object",
                    "additionalProperties": {
                        "type": "object",
                        "properties": {
                            "enabled": {
                                "type": "boolean",
                                "default": true
                            },
                            "name": {
                                "type": "string"
                            },
                            "data": {
                                "type": "object",
                                "additionalProperties": {
                                    "type": "string"
                                }
                            }
                        },
                        "additionalProperties": true
                    }
                },
                "deployments": {
                    "type": "object",
                    "patternProperties": {
                        "^[A-Za-z0-9_-]+$": {
                            "$ref": "#/$defs/pipelineDeployment"
                        }
                    },
                    "additionalProperties": false
                }
            },
            "additionalProperties": false
        },
        "feast": {
            "$ref": "#/$defs/feastConfig"
        },
        "ui": {
            "type": "object",
            "description": "Frontend workload configuration.",
            "required": [
                "enabled",
                "image",
                "resources"
            ],
            "properties": {
                "enabled": {
                    "type": "boolean",
                    "description": "UI deployment toggles must be explicit so production rollouts cannot omit the gate.",
                    "default": true
                },
                "image": {
                    "$ref": "#/$defs/image"
                },
                "resources": {
                    "$ref": "#/$defs/resources"
                }
            },
            "additionalProperties": true
        }
    }
}
