name: Post-Deploy Smoke Tests
on:
  workflow_dispatch:
  schedule:
    - cron: "*/30 * * * *"

permissions:
  contents: read

concurrency:
  group: >-
    ${{ github.workflow }}-${{
      github.event.workflow_run && github.event.workflow_run.pull_requests && github.event.workflow_run.pull_requests[0]
        && github.event.workflow_run.pull_requests[0].number
      || github.event.workflow_run && github.event.workflow_run.head_branch && github.event.workflow_run.head_branch != ''
        && github.event.workflow_run.head_branch
      || github.event.pull_request && github.event.pull_request.number
      || github.head_ref && github.head_ref != '' && github.head_ref
      || github.ref
      || github.event.workflow_run && github.event.workflow_run.run_number
      || github.event.workflow_run && github.event.workflow_run.id
      || github.run_id
    }}
  cancel-in-progress: true



jobs:
  smoke:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false
      - name: Run smoke tests
        env:
          BASE_URL: ${{ secrets.STAGING_URL }}
        run: |
          set -euo pipefail
          if [ -z "${BASE_URL:-}" ]; then
            echo "STAGING_URL secret is not configured." >&2
            exit 1
          fi
          mask_secret() {
            if [ -z "$1" ]; then
              return
            fi
            printf '%s' "$1" | while IFS= read -r line; do
              [ -z "$line" ] && continue
              echo "::add-mask::$line"
            done
          }

          mask_secret "$BASE_URL"

          sanitized_url="${BASE_URL%/}"
          case "${sanitized_url}" in
            https://*) ;;
            *)
              echo "STAGING_URL must start with https:// to enforce TLS." >&2
              exit 1
              ;;
          esac

          if printf '%s' "${sanitized_url}" | LC_ALL=C grep -q '[[:space:]]'; then
            echo "STAGING_URL must not contain whitespace characters." >&2
            exit 1
          fi

          if printf '%s' "${sanitized_url}" | LC_ALL=C grep -q '[[:cntrl:]]'; then
            echo "STAGING_URL must not contain control characters." >&2
            exit 1
          fi

          case "${sanitized_url}" in
            *'@'*)
              echo "STAGING_URL must not include embedded credentials." >&2
              exit 1
              ;;
            *'?'*|*'#'*)
              echo "STAGING_URL must not include query parameters or fragments." >&2
              exit 1
              ;;
          esac

          host_part="${sanitized_url#https://}"
          if [ -z "${host_part}" ]; then
            echo "STAGING_URL must include a hostname." >&2
            exit 1
          fi

          curl --fail --show-error --silent --location --retry 5 --retry-delay 2 --retry-all-errors \
            --proto '=https' --tlsv1.2 "${sanitized_url}/healthz"
          curl --fail --show-error --silent --location --retry 5 --retry-delay 2 --retry-all-errors \
            --proto '=https' --tlsv1.2 "${sanitized_url}/metrics" | grep http_request_duration_seconds
          echo "âœ… Smoke tests passed."
